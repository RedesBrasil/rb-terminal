Especificação: Terminal SSH com Agente IA

Visão Geral
Terminal SSH desktop (Windows .exe) com chat de IA integrado. A IA executa comandos no dispositivo remoto, lê saídas, raciocina e continua iterando até completar a tarefa — similar ao que Claude Code faz para programação, mas para administração de redes/servidores.

Stack Definida

| Componente      | Tecnologia              |
|-----------------|-------------------------|
| Linguagem       | Python 3.11+            |
| GUI             | PySide6                 |
| Agente IA       | PydanticAI              |
| LLM Provider    | OpenRouter              |
| SSH/SFTP        | asyncssh                |
| Terminal Type   | xterm (fallback: vt100) |
| Criptografia    | cryptography (Fernet)   |
| Persistência    | JSON local              |
| Build           | PyInstaller → .exe      |

Justificativas:
- asyncssh: Nativo async (integra melhor com PydanticAI), suporte SFTP integrado, API moderna
- xterm: Suporta cores, compatível com Cisco/Mikrotik/Linux; vt100 como fallback para dispositivos antigos
- cryptography/Fernet: Criptografia simétrica segura para senhas salvas, lib padrão e confiável
- JSON: Simples, sem dependências, fácil backup/edição manual

Funcionalidades Obrigatórias
1. Gerenciador de Hosts

CRUD de hosts (nome, IP, porta, usuário, senha)
Login automático: duplo clique no host → conecta direto sem digitar credenciais
Senha salva criptografada localmente (usando cryptography/Fernet)
Senha opcional: se não salvar, pede no momento da conexão
Salvo em arquivo local (JSON)

2. Terminal SSH

Conexão SSH funcional
Suporte a Mikrotik RouterOS, Cisco IOS, Linux
Múltiplas sessões em abas
Input/output em tempo real
Terminal type: xterm padrão (configurável para vt100 por host)
Histórico de comandos (setas ↑↓)
Suporte a cores ANSI
Redimensionamento de terminal (PTY resize)

3. Gerenciador de Arquivos (SFTP)

Navegação de diretórios do host remoto
Upload de arquivos (local → remoto)
Download de arquivos (remoto → local)
Criar/renomear/deletar arquivos e pastas
Interface visual estilo file browser
Integração com terminal (abrir SFTP na mesma sessão SSH)

4. Chat IA (core do projeto)

Painel lateral ou flutuante no terminal
Ativa/desativa quando quiser
A IA tem acesso a:

execute_command(cmd) → roda comando SSH, retorna output
read_file(path) → lê arquivo remoto via SFTP
write_file(path, content) → cria/edita arquivo remoto via SFTP
list_directory(path) → lista arquivos/pastas do diretório remoto
upload_file(local, remote) → upload via SFTP
download_file(remote, local) → download via SFTP


Loop agêntico: IA executa comando → lê saída → pensa → executa outro → repete até concluir
Histórico de chat persistido localmente por sessão

5. Sem dependências externas

Tudo local (sem banco de dados externo)
Configurações em ~/.rb-terminal/ ou similar

6. Controle e Segurança

Botão "Parar IA": cancela execução a qualquer momento
Confirmação para comandos destrutivos (rm, format, reset, reboot, shutdown, etc.)
Timeout de comandos: 30s padrão, pede confirmação para continuar
Lista de comandos perigosos configurável pelo usuário

7. Gerenciamento de Conexão

Indicador visual de status (conectado/desconectado/reconectando)
Detecção automática de conexão perdida
Botão reconectar
Tratamento de erros: timeout, host unreachable, credenciais inválidas
Mensagens de erro claras para o usuário


Arquitetura Sugerida
rb-terminal/
├── main.py                 # Entry point
├── core/
│   ├── agent.py            # PydanticAI agent + tools
│   ├── ssh_session.py      # Wrapper asyncssh (SSH + SFTP)
│   ├── sftp_manager.py     # Operações SFTP (upload, download, navegação)
│   ├── hosts.py            # CRUD hosts (JSON)
│   ├── crypto.py           # Criptografia de senhas (Fernet)
│   ├── commands.py         # Validação de comandos perigosos
│   └── history.py          # Histórico chat
├── gui/
│   ├── main_window.py      # Janela principal
│   ├── terminal_widget.py  # Widget terminal
│   ├── chat_widget.py      # Widget chat IA
│   ├── file_browser.py     # Widget navegador de arquivos SFTP
│   └── hosts_dialog.py     # Dialog gerenciar hosts
└── config/
    └── settings.json       # API key OpenRouter, preferências

Exemplo de Agent (PydanticAI)

```python
from pydantic_ai import Agent, RunContext
from pydantic import BaseModel
import asyncssh

class SSHSession(BaseModel):
    # wrapper da conexão asyncssh ativa (SSH + SFTP)
    ...

agent = Agent(
    'openrouter/anthropic/claude-3.5-sonnet',
    deps_type=SSHSession,
    system_prompt="""Você é um especialista em Mikrotik, Cisco e Linux.
    Execute comandos SSH para diagnosticar e resolver problemas.
    Sempre leia a saída antes de prosseguir."""
)

@agent.tool
async def execute_command(ctx: RunContext[SSHSession], command: str) -> str:
    """Executa comando SSH e retorna output"""
    return await ctx.deps.execute(command)

@agent.tool
async def read_file(ctx: RunContext[SSHSession], path: str) -> str:
    """Lê arquivo remoto via SFTP"""
    return await ctx.deps.sftp_read(path)

@agent.tool
async def write_file(ctx: RunContext[SSHSession], path: str, content: str) -> str:
    """Escreve arquivo remoto via SFTP"""
    return await ctx.deps.sftp_write(path, content)

@agent.tool
async def list_directory(ctx: RunContext[SSHSession], path: str) -> list[str]:
    """Lista arquivos e pastas do diretório remoto"""
    return await ctx.deps.sftp_listdir(path)
```

Fluxo do Usuário

Abre app → vê lista de hosts salvos
Duplo clique no host → conecta SSH automaticamente (sem digitar senha) → abre terminal
Usa terminal normalmente OU abre chat IA OU abre navegador de arquivos
No chat: "Configure OSPF na ether2 com area 0"
IA executa comandos, lê saídas, itera, responde quando terminar
Usuário vê comandos executados no terminal em tempo real
No file browser: navega pastas, faz upload/download de arquivos


Configuração Inicial

```json
// ~/.rb-terminal/settings.json
{
  "openrouter_api_key": "sk-or-...",
  "default_model": "anthropic/claude-3.5-sonnet",
  "theme": "dark"
}
```

```json
// ~/.rb-terminal/hosts.json
{
  "hosts": [
    {
      "id": "uuid-1234",
      "name": "Mikrotik Principal",
      "host": "192.168.1.1",
      "port": 22,
      "username": "admin",
      "password_encrypted": "gAAAAA...",  // Fernet encrypted
      "terminal_type": "xterm",           // opcional, padrão: xterm
      "created_at": "2025-01-15T10:00:00"
    },
    {
      "id": "uuid-5678",
      "name": "Servidor Linux",
      "host": "10.0.0.50",
      "port": 22,
      "username": "root",
      "password_encrypted": null,         // Pede senha ao conectar
      "terminal_type": "xterm",
      "created_at": "2025-01-16T14:30:00"
    },
    {
      "id": "uuid-9999",
      "name": "Switch Antigo",
      "host": "192.168.1.254",
      "port": 22,
      "username": "admin",
      "password_encrypted": "gAAAAB...",
      "terminal_type": "vt100",           // fallback para dispositivos antigos
      "created_at": "2025-01-17T09:00:00"
    }
  ]
}
```

Entregáveis

Código fonte Python
Executável Windows (.exe) via PyInstaller
Documentação básica de uso


Fora do Escopo (v1)

Suporte a chaves SSH (só usuário/senha por ora)
Múltiplos provedores de IA simultaneamente
Versão Mac/Linux (só Windows .exe inicialmente)
